var ROS3D=function(t){"use strict";const e=function(t,e){var o=new THREE.Vector3;o.subVectors(t.origin,e.origin);var n=e.direction.clone(),i=t.direction.clone(),r=o.dot(n),a=n.dot(i),s=o.dot(i),E=n.dot(n),c=i.dot(i)*E-a*a;if(!(Math.abs(c)<=1e-4))return(r*a-s*E)/c},o=function(t){THREE.Object3D.call(this),THREE.EventDispatcher.call(this);var e=this,o=(t=t||{}).handle;this.name=o.name;var n=t.camera,i=t.path||"/",r=t.loader||ROS3D.COLLADA_LOADER_2;this.dragging=!1,this.onServerSetPose({pose:o.pose}),this.dragStart={position:new THREE.Vector3,orientation:new THREE.Quaternion,positionWorld:new THREE.Vector3,orientationWorld:new THREE.Quaternion,event3d:{}},o.controls.forEach(function(t){e.add(new ROS3D.InteractiveMarkerControl({parent:e,handle:o,message:t,camera:n,path:i,loader:r}))}),o.menuEntries.length>0&&(this.menu=new ROS3D.InteractiveMarkerMenu({menuEntries:o.menuEntries,menuFontSize:o.menuFontSize}),this.menu.addEventListener("menu-select",function(t){e.dispatchEvent(t)}))};return o.prototype.__proto__=THREE.Object3D.prototype,o.prototype.showMenu=function(t,e){this.menu&&this.menu.show(t,e)},o.prototype.moveAxis=function(t,e,o){if(this.dragging){var n=t.currentControlOri,i=e.clone().applyQuaternion(n),r=this.dragStart.event3d.intersection.point,a=i.clone().applyQuaternion(this.dragStart.orientationWorld.clone()),s=new THREE.Ray(r,a),E=ROS3D.closestAxisPoint(s,o.camera,o.mousePos),c=new THREE.Vector3;c.addVectors(this.dragStart.position,i.clone().applyQuaternion(this.dragStart.orientation).multiplyScalar(E)),this.setPosition(t,c),o.stopPropagation()}},o.prototype.movePlane=function(t,e,o){if(this.dragging){var n=t.currentControlOri,i=e.clone().applyQuaternion(n),r=this.dragStart.event3d.intersection.point,a=i.clone().applyQuaternion(this.dragStart.orientationWorld),s=ROS3D.intersectPlane(o.mouseRay,r,a),E=new THREE.Vector3;E.subVectors(s,r),E.add(this.dragStart.positionWorld),this.setPosition(t,E),o.stopPropagation()}},o.prototype.rotateAxis=function(t,e,o){if(this.dragging){t.updateMatrixWorld();var n=t.currentControlOri.clone().multiply(e.clone()),i=new THREE.Vector3(1,0,0).applyQuaternion(n),r=this.dragStart.event3d.intersection.point,a=i.applyQuaternion(this.dragStart.orientationWorld),s=ROS3D.intersectPlane(o.mouseRay,r,a),E=new THREE.Ray(this.dragStart.positionWorld,a),c=ROS3D.intersectPlane(E,r,a),R=this.dragStart.orientationWorld.clone().multiply(n).clone().inverse();s.sub(c),s.applyQuaternion(R);var p=this.dragStart.event3d.intersection.point.clone();p.sub(c),p.applyQuaternion(R);var d=Math.atan2(s.y,s.z),l=Math.atan2(p.y,p.z)-d,u=new THREE.Quaternion;u.setFromAxisAngle(i,l),this.setOrientation(t,u.multiply(this.dragStart.orientationWorld)),o.stopPropagation()}},o.prototype.feedbackEvent=function(t,e){this.dispatchEvent({type:t,position:this.position.clone(),orientation:this.quaternion.clone(),controlName:e.name})},o.prototype.startDrag=function(t,e){if(0===e.domEvent.button){e.stopPropagation(),this.dragging=!0,this.updateMatrixWorld(!0);var o=new THREE.Vector3;this.matrixWorld.decompose(this.dragStart.positionWorld,this.dragStart.orientationWorld,o),this.dragStart.position=this.position.clone(),this.dragStart.orientation=this.quaternion.clone(),this.dragStart.event3d=e,this.feedbackEvent("user-mousedown",t)}},o.prototype.stopDrag=function(t,e){0===e.domEvent.button&&(e.stopPropagation(),this.dragging=!1,this.dragStart.event3d={},this.onServerSetPose(this.bufferedPoseEvent),this.bufferedPoseEvent=void 0,this.feedbackEvent("user-mouseup",t))},o.prototype.buttonClick=function(t,e){e.stopPropagation(),this.feedbackEvent("user-button-click",t)},o.prototype.setPosition=function(t,e){this.position.copy(e),this.feedbackEvent("user-pose-change",t)},o.prototype.setOrientation=function(t,e){e.normalize(),this.quaternion.copy(e),this.feedbackEvent("user-pose-change",t)},o.prototype.onServerSetPose=function(t){if(void 0!==t)if(this.dragging)this.bufferedPoseEvent=t;else{var e=t.pose;this.position.copy(e.position),this.quaternion.copy(e.orientation),this.updateMatrixWorld(!0)}},o.prototype.dispose=function(){var t=this;this.children.forEach(function(e){e.children.forEach(function(t){t.dispose(),e.remove(t)}),t.remove(e)})},Object.assign(ROS3D.InteractiveMarker.prototype,THREE.EventDispatcher.prototype),t.REVISION="0.18.0",t.MARKER_ARROW=0,t.MARKER_CUBE=1,t.MARKER_SPHERE=2,t.MARKER_CYLINDER=3,t.MARKER_LINE_STRIP=4,t.MARKER_LINE_LIST=5,t.MARKER_CUBE_LIST=6,t.MARKER_SPHERE_LIST=7,t.MARKER_POINTS=8,t.MARKER_TEXT_VIEW_FACING=9,t.MARKER_MESH_RESOURCE=10,t.MARKER_TRIANGLE_LIST=11,t.INTERACTIVE_MARKER_KEEP_ALIVE=0,t.INTERACTIVE_MARKER_POSE_UPDATE=1,t.INTERACTIVE_MARKER_MENU_SELECT=2,t.INTERACTIVE_MARKER_BUTTON_CLICK=3,t.INTERACTIVE_MARKER_MOUSE_DOWN=4,t.INTERACTIVE_MARKER_MOUSE_UP=5,t.INTERACTIVE_MARKER_NONE=0,t.INTERACTIVE_MARKER_MENU=1,t.INTERACTIVE_MARKER_BUTTON=2,t.INTERACTIVE_MARKER_MOVE_AXIS=3,t.INTERACTIVE_MARKER_MOVE_PLANE=4,t.INTERACTIVE_MARKER_ROTATE_AXIS=5,t.INTERACTIVE_MARKER_MOVE_ROTATE=6,t.INTERACTIVE_MARKER_INHERIT=0,t.INTERACTIVE_MARKER_FIXED=1,t.INTERACTIVE_MARKER_VIEW_FACING=2,t.makeColorMaterial=function(t,e,o,n){var i=new THREE.Color;return i.setRGB(t,e,o),n<=.99?new THREE.MeshBasicMaterial({color:i.getHex(),opacity:n+.1,transparent:!0,depthWrite:!0,blendSrc:THREE.SrcAlphaFactor,blendDst:THREE.OneMinusSrcAlphaFactor,blendEquation:THREE.ReverseSubtractEquation,blending:THREE.NormalBlending}):new THREE.MeshPhongMaterial({color:i.getHex(),opacity:n,blending:THREE.NormalBlending})},t.intersectPlane=function(t,e,o){var n=new THREE.Vector3,i=new THREE.Vector3;n.subVectors(e,t.origin);var r=t.direction.dot(o);if(!(Math.abs(r)<t.precision)){var a=o.dot(n)/r;return i.addVectors(t.origin,t.direction.clone().multiplyScalar(a)),i}},t.findClosestPoint=e,t.closestAxisPoint=function(t,o,n){var i=t.origin.clone();i.project(o);var r=t.direction.clone().add(t.origin);r.project(o);var a=r.clone().sub(i),s=(new THREE.Vector2).subVectors(n,i).dot(a)/a.dot(a),E=new THREE.Vector2;E.addVectors(i,a.clone().multiplyScalar(s));var c=new THREE.Vector3(E.x,E.y,.5);c.unproject(o);var R=new THREE.Ray(o.position,c.sub(o.position).normalize());return e(t,R)},t.InteractiveMarker=o,t}({});
